name: åŒæ­¥æ–‡ç« ï¼ˆä»Issuesåˆ°JSONï¼‰
on:
  # ç›‘å¬Issuesçš„åˆ›å»º/ç¼–è¾‘/æ‰“æ ‡ç­¾äº‹ä»¶
  issues:
    types: [opened, edited, labeled]
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  sync-articles:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # 2. å®‰è£…jqï¼ˆç”¨äºJSONè§£æï¼ŒUbuntuè‡ªå¸¦ï¼‰
      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq

      # 3. å¤„ç†æ–‡ç« åŒæ­¥é€»è¾‘
      - name: åŒæ­¥æ–‡ç« æ•°æ®
        env:
          # ä¼ å…¥GitHubäº‹ä»¶æ•°æ®
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels) }}
          ISSUE_ACTION: ${{ github.event.action }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # åˆå§‹åŒ–articles.jsonï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f "data/articles.json" ]; then
            mkdir -p data
            echo '{"articles": [], "lastUpdate": ""}' > data/articles.json
          fi

          # ========== å¤„ç†ã€Œæ–°å¢æ–‡ç« ã€ ==========
          if [[ "$ISSUE_TITLE" == "æ–°å¢æ–‡ç« " ]]; then
            # éªŒè¯Issueæ­£æ–‡æ˜¯å¦ä¸ºåˆæ³•JSON
            if echo "$ISSUE_BODY" | jq . > /dev/null 2>&1; then
              # è¯»å–ç°æœ‰æ–‡ç« 
              EXISTING=$(cat data/articles.json)
              # è§£ææ–°æ–‡ç« æ•°æ®
              NEW_ARTICLE=$(echo "$ISSUE_BODY" | jq .)
              # åˆå¹¶åˆ°æ•°ç»„ï¼ˆå»é‡+æœ€æ–°çš„æ”¾å‰é¢ï¼‰
              UPDATED=$(echo "$EXISTING" | jq \
                --argjson new "$NEW_ARTICLE" \
                '.articles = [$new] + (.articles | map(select(.id != $new.id))) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              # å†™å…¥æ–‡ä»¶
              echo "$UPDATED" > data/articles.json
              echo "âœ… æ–°å¢æ–‡ç« æˆåŠŸï¼"
            else
              echo "âŒ Issueæ­£æ–‡ä¸æ˜¯åˆæ³•JSONï¼ŒåŒæ­¥å¤±è´¥"
              exit 1
            fi
          fi

          # ========== å¤„ç†ã€Œç¼–è¾‘æ–‡ç« ã€ ==========
          if [[ "$ISSUE_TITLE" == "ç¼–è¾‘æ–‡ç« " ]]; then
            if echo "$ISSUE_BODY" | jq . > /dev/null 2>&1; then
              EXISTING=$(cat data/articles.json)
              UPDATED_ARTICLE=$(echo "$ISSUE_BODY" | jq .)
              ARTICLE_ID=$(echo "$UPDATED_ARTICLE" | jq -r '.id')
              # æ›¿æ¢å¯¹åº”IDçš„æ–‡ç« 
              UPDATED=$(echo "$EXISTING" | jq \
                --argjson updated "$UPDATED_ARTICLE" \
                --arg id "$ARTICLE_ID" \
                '.articles = (.articles | map(if .id == $id then $updated else . end)) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              echo "$UPDATED" > data/articles.json
              echo "âœ… ç¼–è¾‘æ–‡ç« æˆåŠŸï¼"
            else
              echo "âŒ Issueæ­£æ–‡ä¸æ˜¯åˆæ³•JSONï¼ŒåŒæ­¥å¤±è´¥"
              exit 1
            fi
          fi

          # ========== å¤„ç†ã€Œåˆ é™¤æ–‡ç« ã€ ==========
          if [[ "$ISSUE_ACTION" == "labeled" ]]; then
            # æå–æ ‡ç­¾ï¼ˆæ ¼å¼ï¼šdelete-article-<ID>ï¼‰
            LABEL_NAME=$(echo "$ISSUE_LABELS" | jq -r '.[0].name')
            if [[ "$LABEL_NAME" =~ ^delete-article- ]]; then
              ARTICLE_ID=${LABEL_NAME#delete-article-}
              EXISTING=$(cat data/articles.json)
              # è¿‡æ»¤æ‰è¦åˆ é™¤çš„æ–‡ç« 
              UPDATED=$(echo "$EXISTING" | jq \
                --arg id "$ARTICLE_ID" \
                '.articles = (.articles | map(select(.id != $id))) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              echo "$UPDATED" > data/articles.json
              echo "âœ… åˆ é™¤æ–‡ç« ID:$ARTICLE_ID æˆåŠŸï¼"
            fi
          fi

      # 4. æäº¤å¹¶æ¨é€ä¿®æ”¹åˆ°ä»“åº“
      - name: æäº¤ä¿®æ”¹
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git status --porcelain | grep -q "data/articles.json"; then
            git add data/articles.json
            git commit -m "ğŸ”„ åŒæ­¥æ–‡ç« ï¼ˆæ¥è‡ªIssue #$ISSUE_NUMBERï¼‰"
            git push
            echo "âœ… æ¨é€ä¿®æ”¹åˆ°ä»“åº“æˆåŠŸï¼"
          else
            echo "â„¹ï¸ æ— æ–‡ç« æ•°æ®ä¿®æ”¹ï¼Œæ— éœ€æ¨é€"
          fi