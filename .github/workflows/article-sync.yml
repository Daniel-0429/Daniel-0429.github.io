name: åŒæ­¥æ–‡ç« ï¼ˆä»Issuesåˆ°JSONï¼‰
permissions:
  contents: write
  issues: read
on:
  issues:
    types: [opened, edited, labeled]
  workflow_dispatch:

jobs:
  sync-articles:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é¡»ï¼Œé¿å…æ¨é€å†²çª

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: åŒæ­¥æ–‡ç« æ•°æ®
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels) }}
          ISSUE_ACTION: ${{ github.event.action }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # åˆå§‹åŒ–articles.json
          if [ ! -f "data/articles.json" ]; then
            mkdir -p data
            echo '{"articles": [], "lastUpdate": ""}' > data/articles.json
          fi

          # ========== ç»ˆæå…¼å®¹ï¼šå¤„ç†é•¿æ–‡æœ¬/å¤šæ¢è¡Œç¬¦/ç‰¹æ®Šå­—ç¬¦çš„JSON ==========
          # 1. å»é™¤æ‰€æœ‰Markdownä»£ç å—ã€é¦–å°¾ç©ºè¡Œ
          # 2. å»é™¤Windowsæ¢è¡Œç¬¦(\r)ã€å¤šä½™ç©ºæ ¼
          # 3. å¼ºåˆ¶UTF-8ç¼–ç ï¼Œé¿å…ä¸­æ–‡ä¹±ç 
          CLEANED_BODY=$(echo "$ISSUE_BODY" | \
            sed -e '/^```json/,/^```/d' -e 's/```//g' \
            | tr -d '\r' | awk '{$1=$1};1' | iconv -f UTF-8 -t UTF-8 -c)

          # ========== è°ƒè¯•ï¼šæ‰“å°å…³é”®ä¿¡æ¯ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰ ==========
          echo "=== åŸå§‹Issueæ­£æ–‡ï¼ˆå‰500å­—ç¬¦ï¼‰ ==="
          echo "${ISSUE_BODY:0:500}"
          echo "=== æ¸…ç†åæ­£æ–‡ï¼ˆå‰500å­—ç¬¦ï¼‰ ==="
          echo "${CLEANED_BODY:0:500}"

          # ========== å¤„ç†ã€Œæ–°å¢æ–‡ç« ã€ ==========
          if [[ "$ISSUE_TITLE" == "æ–°å¢æ–‡ç« " ]]; then
            # ç”¨jqå®‰å…¨è§£æï¼ˆå…è®¸å¤šè¡ŒJSONã€ç‰¹æ®Šå­—ç¬¦ï¼‰
            if NEW_ARTICLE=$(echo "$CLEANED_BODY" | jq . 2>/dev/null); then
              EXISTING=$(cat data/articles.json)
              # åˆå¹¶æ–‡ç« ï¼ˆå»é‡+æœ€æ–°åœ¨å‰ï¼‰
              UPDATED=$(echo "$EXISTING" | jq \
                --argjson new "$NEW_ARTICLE" \
                '.articles = [$new] + (.articles | map(select(.id != $new.id))) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              echo "$UPDATED" > data/articles.json
              echo "âœ… æ–°å¢æ–‡ç« æˆåŠŸï¼"
            else
              echo "âŒ JSONè§£æå¤±è´¥ï¼Œè¯¦ç»†æŠ¥é”™ï¼š"
              echo "$CLEANED_BODY" | jq .  # æ‰“å°jqçš„å…·ä½“æŠ¥é”™
              exit 1
            fi
          fi

          # ========== å¤„ç†ã€Œç¼–è¾‘æ–‡ç« ã€ ==========
          if [[ "$ISSUE_TITLE" == "ç¼–è¾‘æ–‡ç« " ]]; then
            if UPDATED_ARTICLE=$(echo "$CLEANED_BODY" | jq . 2>/dev/null); then
              EXISTING=$(cat data/articles.json)
              ARTICLE_ID=$(echo "$UPDATED_ARTICLE" | jq -r '.id')
              # æ›¿æ¢å¯¹åº”IDçš„æ–‡ç« 
              UPDATED=$(echo "$EXISTING" | jq \
                --argjson updated "$UPDATED_ARTICLE" \
                --arg id "$ARTICLE_ID" \
                '.articles = (.articles | map(if .id == $id then $updated else . end)) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              echo "$UPDATED" > data/articles.json
              echo "âœ… ç¼–è¾‘æ–‡ç« æˆåŠŸï¼"
            else
              echo "âŒ JSONè§£æå¤±è´¥ï¼Œè¯¦ç»†æŠ¥é”™ï¼š"
              echo "$CLEANED_BODY" | jq .
              exit 1
            fi
          fi

          # ========== å¤„ç†ã€Œåˆ é™¤æ–‡ç« ã€ ==========
          if [[ "$ISSUE_ACTION" == "labeled" ]]; then
            LABEL_NAME=$(echo "$ISSUE_LABELS" | jq -r '.[0].name')
            if [[ "$LABEL_NAME" =~ ^delete-article- ]]; then
              ARTICLE_ID=${LABEL_NAME#delete-article-}
              EXISTING=$(cat data/articles.json)
              UPDATED=$(echo "$EXISTING" | jq \
                --arg id "$ARTICLE_ID" \
                '.articles = (.articles | map(select(.id != $id))) | .lastUpdate = "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"'
              )
              echo "$UPDATED" > data/articles.json
              echo "âœ… åˆ é™¤æ–‡ç« ID:$ARTICLE_ID æˆåŠŸï¼"
            fi
          fi

      - name: æäº¤ä¿®æ”¹
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git status --porcelain | grep -q "data/articles.json"; then
            git add data/articles.json
            git commit -m "ğŸ”„ åŒæ­¥æ–‡ç« ï¼ˆæ¥è‡ªIssue #$ISSUE_NUMBERï¼‰"
            git push origin main
            echo "âœ… æ¨é€ä¿®æ”¹åˆ°ä»“åº“æˆåŠŸï¼"
          else
            echo "â„¹ï¸ æ— æ–‡ç« æ•°æ®ä¿®æ”¹ï¼Œæ— éœ€æ¨é€"
          fi